<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/investmentCalculations.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/investmentCalculations.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Investment Calculations - Buy-Rent-Hold Analysis
 * ================================================
 * MATCHES THE EXCEL SPREADSHEET EXACTLY
 * Location: src/utils/investmentCalculations.js
 */

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================
/**
 * Calculate monthly mortgage payment using PMT formula
 * 
 * Uses the standard amortization formula to calculate monthly payment:
 * Payment = P * [r(1+r)^n] / [(1+r)^n - 1]
 * Where: P = principal, r = monthly rate, n = number of payments
 * 
 * @function
 * @param {number} principal - Loan principal amount in dollars
 * @param {number} annualRate - Annual interest rate as percentage (e.g., 7.0 for 7%)
 * @param {number} years - Loan term in years (e.g., 30)
 * @returns {number} Monthly payment amount in dollars
 * 
 * @example
 * // Calculate payment for $200,000 loan at 7% for 30 years
 * const payment = calculateMonthlyPayment(200000, 7.0, 30);
 * console.log(payment); // 1330.60
 */
function calculateMonthlyPayment(principal, annualRate, years) {
  if (!principal || principal === 0) return 0;
  if (!annualRate || annualRate === 0) return principal / (years * 12);
  if (!years || years === 0) return 0;
  
  const monthlyRate = annualRate / 100 / 12;
  const numPayments = years * 12;
  
  return (principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
         (Math.pow(1 + monthlyRate, numPayments) - 1);
}

/**
 * Calculate total principal paid in Year 1
 * 
 * Amortizes the loan month-by-month for the first year to determine
 * total principal paydown. This is used for equity ROI calculations.
 * 
 * @function
 * @param {number} loanAmount - Initial loan amount in dollars
 * @param {number} monthlyPayment - Monthly payment amount in dollars
 * @param {number} annualRate - Annual interest rate as percentage
 * @returns {number} Total principal paid in first year
 * 
 * @example
 * const principal = calculatePrincipalPaidYear1(200000, 1330.60, 7.0);
 * console.log(principal); // ~3,800
 */
function calculatePrincipalPaidYear1(loanAmount, monthlyPayment, annualRate) {
  if (!loanAmount || !monthlyPayment) return 0;
  
  let totalPrincipal = 0;
  let balance = loanAmount;
  const monthlyRate = (annualRate || 0) / 100 / 12;
  
  for (let month = 1; month &lt;= 12; month++) {
    const interestPayment = balance * monthlyRate;
    const principalPayment = monthlyPayment - interestPayment;
    totalPrincipal += Math.max(0, principalPayment);
    balance -= principalPayment;
  }
  
  return totalPrincipal;
}

// =============================================================================
// MAIN CALCULATOR CLASS
// =============================================================================
/**
 * Buy, Rent, and Hold investment calculator
 * 
 * Comprehensive calculator class that matches Excel spreadsheet methodology.
 * Calculates all financial metrics for rental property investment analysis
 * including purchase costs, financing, income, expenses, NOI, cash flow,
 * and investment returns.
 * 
 * @class
 * 
 * @example
 * const property = { address: '123 Main St', price: 250000 };
 * const inputs = {
 *   offerPrice: 250000,
 *   repairs: 10000,
 *   grossRents: 24000,
 *   firstMtgLTV: 80,
 *   firstMtgRate: 7.0
 * };
 * 
 * const calculator = new BuyRentHoldCalculator(property, inputs);
 * const analysis = calculator.getCompleteAnalysis();
 * console.log(analysis.quickAnalysis.cashOnCashROI); // 8.5%
 */

export class BuyRentHoldCalculator {
  /**
   * Create a calculator instance
   * 
   * @constructor
   * @param {Object} property - Property data object
   * @param {string} [property.address] - Property address
   * @param {number} [property.price] - Property list price
   * @param {number} [property.beds] - Number of bedrooms
   * @param {number} [property.baths] - Number of bathrooms
   * @param {Object} inputs - Investment calculation inputs
   * @param {number} inputs.offerPrice - Proposed offer price
   * @param {number} [inputs.fairMarketValue] - Fair market value (defaults to offerPrice)
   * @param {number} [inputs.repairs=0] - Estimated repair costs
   * @param {number} [inputs.purchaseCostsPercent=3.0] - Closing costs as percentage
   * @param {number} [inputs.firstMtgLTV=80] - Loan-to-value ratio as percentage
   * @param {number} [inputs.firstMtgRate=7.0] - Mortgage interest rate as percentage
   * @param {number} [inputs.firstMtgAmortization=30] - Loan term in years
   * @param {number} inputs.grossRents - Annual gross rental income
   * @param {number} [inputs.vacancyRate=5.0] - Vacancy rate as percentage
   * @param {number} [inputs.managementRate=10.0] - Management fee as percentage
   * @param {number} [inputs.propertyTaxes=0] - Annual property taxes
   * @param {number} [inputs.insurance=0] - Annual insurance cost
   * @param {number} [inputs.appreciationRate=3.0] - Annual appreciation as percentage
   */
  constructor(property, inputs) {
    this.property = property || {};
    this.inputs = inputs || {};
  }

  // SECTION 1: Property Info

  /**
   * Get property information
   * 
   * Extracts and standardizes property details from inputs and property data.
   * Provides default values for missing fields.
   * 
   * @returns {Object} Property information
   * @returns {string} returns.address - Property address
   * @returns {number} returns.fairMarketValue - Fair market value
   * @returns {number} returns.vacancyRate - Vacancy rate percentage
   * @returns {number} returns.managementRate - Management rate percentage
   * @returns {number} returns.advertisingCost - Advertising cost
   * @returns {number} returns.numberOfUnits - Number of rental units
   * @returns {number} returns.appreciationRate - Annual appreciation percentage
   */
  getPropertyInfo() {
    return {
      address: this.property.address || '',
      fairMarketValue: this.inputs.fairMarketValue || this.inputs.offerPrice || this.property.price || 0,
      vacancyRate: this.inputs.vacancyRate ?? 5.0,
      managementRate: this.inputs.managementRate ?? 10.0,
      advertisingCost: this.inputs.advertisingCost ?? 100,
      numberOfUnits: this.inputs.numberOfUnits || 1,
      appreciationRate: this.inputs.appreciationRate ?? 3.0
    };
  }

  // SECTION 2: Purchase Info → Real Purchase Price (RPP)
  /**
   * Calculate purchase information and Real Purchase Price (RPP)
   * 
   * Computes the total cost of acquisition including offer price, repairs,
   * and all closing costs. Supports both percentage-based and itemized
   * closing costs.
   * 
   * Formula: RPP = Offer Price + Repairs + Repairs Contingency + Closing Costs
   * 
   * @returns {Object} Purchase details
   * @returns {number} returns.offerPrice - Proposed offer price
   * @returns {number} returns.repairs - Repair costs
   * @returns {number} returns.repairsContingency - Additional repair buffer
   * @returns {number} returns.closingCosts - Total closing costs
   * @returns {number} returns.realPurchasePrice - Total acquisition cost (RPP)
   * @returns {number} returns.lenderFee - Lender fees
   * @returns {number} returns.brokerFee - Broker fees
   * @returns {number} returns.environmentals - Environmental inspection costs
   * @returns {number} returns.inspections - Home inspection costs
   * @returns {number} returns.appraisals - Appraisal costs
   * @returns {number} returns.misc - Miscellaneous costs
   * @returns {number} returns.transferTax - Transfer tax
   * @returns {number} returns.legal - Legal fees
   */
  calculatePurchaseInfo() {
    const {
      offerPrice = 0,
      repairs = 0,
      repairsContingency = 0,
      lenderFee = 0,
      brokerFee = 0,
      environmentals = 0,
      inspections = 0,
      appraisals = 0,
      misc = 0,
      transferTax = 0,
      legal = 0
    } = this.inputs;

    // Support purchaseCostsTotal if provided (from worksheet)
    let closingCosts;
    if (this.inputs.purchaseCostsTotal !== undefined &amp;&amp; this.inputs.purchaseCostsTotal > 0) {
      closingCosts = this.inputs.purchaseCostsTotal;
    } else if (this.inputs.purchaseCostsPercent !== undefined &amp;&amp; this.inputs.purchaseCostsPercent > 0) {
      closingCosts = offerPrice * (this.inputs.purchaseCostsPercent / 100);
    } else {
      closingCosts = lenderFee + brokerFee + environmentals + inspections + 
                     appraisals + misc + transferTax + legal;
    }

    const realPurchasePrice = offerPrice + repairs + repairsContingency + closingCosts;

    return {
      offerPrice,
      repairs,
      repairsContingency,
      lenderFee,
      brokerFee,
      environmentals,
      inspections,
      appraisals,
      misc,
      transferTax,
      legal,
      closingCosts,
      realPurchasePrice
    };
  }

  // SECTION 3: Financing → Cash Required to Close
  /**
   * 
   * Computes mortgage details for up to three loan types (first mortgage,
   * second mortgage, interest-only), calculates monthly payments, and
   * determines total cash needed at closing.
   * 
   * Supports CMHC insurance fees (Canadian mortgage insurance).
   * 
   * @returns {Object} Financing details
   * @returns {Object} returns.firstMtg - First mortgage details
   * @returns {number} returns.firstMtg.principalBorrowed - Amount borrowed (before CMHC)
   * @returns {number} returns.firstMtg.rate - Interest rate percentage
   * @returns {number} returns.firstMtg.amortization - Loan term in years
   * @returns {number} returns.firstMtg.cmhcFeePercent - CMHC fee percentage
   * @returns {number} returns.firstMtg.cmhcAmount - CMHC fee amount
   * @returns {number} returns.firstMtg.totalPrincipal - Total loan including CMHC
   * @returns {number} returns.firstMtg.monthlyPayment - Monthly P&amp;I payment
   * @returns {number} returns.firstMtg.ltv - Loan-to-value percentage
   * @returns {Object} returns.secondMtg - Second mortgage details
   * @returns {Object} returns.interestOnly - Interest-only loan details
   * @returns {number} returns.otherMonthlyFinancingCosts - Other monthly costs
   * @returns {number} returns.cashRequiredToClose - Total cash needed at closing
   */
  calculateFinancing() {
    const purchase = this.calculatePurchaseInfo();
    const { offerPrice } = this.inputs;

    const firstMtgLTV = this.inputs.firstMtgLTV ?? 80;
    const firstMtgRate = this.inputs.firstMtgRate ?? 7.0;
    const firstMtgAmortization = this.inputs.firstMtgAmortization ?? 30;
    const firstMtgCMHCFeePercent = this.inputs.firstMtgCMHCFee ?? 0;

    const firstMtgPrincipalBorrowed = offerPrice * (firstMtgLTV / 100);
    const firstMtgCMHCAmount = firstMtgPrincipalBorrowed * (firstMtgCMHCFeePercent / 100);
    const firstMtgTotalPrincipal = firstMtgPrincipalBorrowed + firstMtgCMHCAmount;
    const firstMtgMonthlyPayment = calculateMonthlyPayment(
      firstMtgTotalPrincipal,
      firstMtgRate,
      firstMtgAmortization
    );

    const secondMtgPrincipal = this.inputs.secondMtgPrincipal || 0;
    const secondMtgRate = this.inputs.secondMtgRate ?? 12.0;
    const secondMtgAmortization = this.inputs.secondMtgAmortization || 9999;
    const secondMtgMonthlyPayment = secondMtgPrincipal > 0
      ? calculateMonthlyPayment(secondMtgPrincipal, secondMtgRate, Math.min(secondMtgAmortization, 30))
      : 0;

    const interestOnlyPrincipal = this.inputs.interestOnlyPrincipal || 0;
    const interestOnlyRate = this.inputs.interestOnlyRate || 0;
    const interestOnlyMonthlyPayment = interestOnlyPrincipal > 0
      ? (interestOnlyPrincipal * interestOnlyRate / 100) / 12
      : 0;

    const otherMonthlyFinancingCosts = this.inputs.otherMonthlyFinancingCosts || 0;
    const cashRequiredToClose = purchase.realPurchasePrice - firstMtgPrincipalBorrowed - secondMtgPrincipal;

    return {
      firstMtg: {
        principalBorrowed: firstMtgPrincipalBorrowed,
        rate: firstMtgRate,
        amortization: firstMtgAmortization,
        cmhcFeePercent: firstMtgCMHCFeePercent,
        cmhcAmount: firstMtgCMHCAmount,
        totalPrincipal: firstMtgTotalPrincipal,
        monthlyPayment: firstMtgMonthlyPayment,
        ltv: firstMtgLTV
      },
      secondMtg: {
        principal: secondMtgPrincipal,
        rate: secondMtgRate,
        amortization: secondMtgAmortization,
        monthlyPayment: secondMtgMonthlyPayment
      },
      interestOnly: {
        principal: interestOnlyPrincipal,
        rate: interestOnlyRate,
        monthlyPayment: interestOnlyMonthlyPayment
      },
      otherMonthlyFinancingCosts,
      cashRequiredToClose
    };
  }

  // SECTION 4: Income Annual → Effective Gross Income(EGI)
  /**
   * 
   * Computes total rental income from all sources, subtracts vacancy loss,
   * and calculates EGI which is used for NOI calculation.
   * 
   * Formula: EGI = Total Income - (Total Income × Vacancy Rate)
   * 
   * @returns {Object} Income details
   * @returns {number} returns.grossRents - Annual gross rents
   * @returns {number} returns.parking - Annual parking income
   * @returns {number} returns.storage - Annual storage income
   * @returns {number} returns.laundry - Annual laundry income
   * @returns {number} returns.otherIncome - Other annual income
   * @returns {number} returns.totalIncome - Total annual income (before vacancy)
   * @returns {number} returns.vacancyLoss - Expected vacancy loss
   * @returns {number} returns.vacancyRate - Vacancy rate percentage
   * @returns {number} returns.effectiveGrossIncome - EGI (total income minus vacancy)
   */
  calculateIncome() {
    const {
      grossRents = 0,
      parking = 0,
      storage = 0,
      laundry = 0,
      otherIncome = 0
    } = this.inputs;

    const propertyInfo = this.getPropertyInfo();
    const totalIncome = grossRents + parking + storage + laundry + otherIncome;
    const vacancyLoss = totalIncome * (propertyInfo.vacancyRate / 100);
    const effectiveGrossIncome = totalIncome - vacancyLoss;

    return {
      grossRents,
      parking,
      storage,
      laundry,
      otherIncome,
      totalIncome,
      vacancyLoss,
      vacancyRate: propertyInfo.vacancyRate,
      effectiveGrossIncome
    };
  }

  // SECTION 5: Operating Expenses Annual
  /**
   * 
   * Computes all operating expenses for the property. Repairs and management
   * are calculated as percentages of gross rents (Excel methodology).
   * All other expenses are entered as fixed annual amounts.
   * 
   * @returns {Object} Operating expenses breakdown
   * @returns {number} returns.propertyTaxes - Annual property taxes
   * @returns {number} returns.insurance - Annual insurance cost
   * @returns {number} returns.repairs - Annual repairs (calculated from gross rents)
   * @returns {number} returns.repairsPercent - Repairs percentage of gross rents
   * @returns {number} returns.management - Annual management fee (calculated)
   * @returns {number} returns.managementPercent - Management percentage of gross rents
   * @returns {number} returns.electricity - Annual electricity cost
   * @returns {number} returns.gas - Annual gas cost
   * @returns {number} returns.waterSewer - Annual water/sewer cost
   * @returns {number} returns.cable - Annual cable/internet cost
   * @returns {number} returns.associationFees - Annual HOA/condo fees
   * @returns {number} returns.totalExpenses - Total annual operating expenses
   */
  calculateOperatingExpenses() {
    const income = this.calculateIncome();
    const propertyInfo = this.getPropertyInfo();

    const {
      propertyTaxes = 0,
      insurance = 0,
      repairsPercent = 5.0,
      electricity = 0,
      gas = 0,
      lawnMaintenance = 0,
      waterSewer = 0,
      cable = 0,
      caretaking = 0,
      advertising = 0,
      associationFees = 0,
      pestControl = 0,
      security = 0,
      trashRemoval = 0,
      miscellaneous = 0,
      commonArea = 0,
      capitalImprovements = 0,
      accounting = 0,
      legalExpenses = 0,
      badDebts = 0,
      otherExpenses = 0,
      evictions = 0
    } = this.inputs;

    // Repairs and Management based on Gross Rents (Excel methodology)
    const repairs = income.grossRents * (repairsPercent / 100);
    const management = income.grossRents * (propertyInfo.managementRate / 100);

    const totalExpenses = 
      propertyTaxes + insurance + repairs + electricity + gas + 
      lawnMaintenance + waterSewer + cable + management + caretaking + 
      advertising + associationFees + pestControl + security + 
      trashRemoval + miscellaneous + commonArea + capitalImprovements + 
      accounting + legalExpenses + badDebts + otherExpenses + evictions;

    return {
      propertyTaxes,
      insurance,
      repairs,
      repairsPercent,
      electricity,
      gas,
      lawnMaintenance,
      waterSewer,
      cable,
      management,
      managementPercent: propertyInfo.managementRate,
      caretaking,
      advertising,
      associationFees,
      pestControl,
      security,
      trashRemoval,
      miscellaneous,
      commonArea,
      capitalImprovements,
      accounting,
      legalExpenses,
      badDebts,
      otherExpenses,
      evictions,
      totalExpenses
    };
  }

  // SECTION 6: Net Operating Income
   /**
   * Calculate Net Operating Income (NOI)
   * 
   * NOI is the income remaining after all operating expenses but before
   * debt service (mortgage payments). This is a key metric used to calculate
   * Cap Rate and other investment ratios.
   * 
   * Formula: NOI = Effective Gross Income - Total Operating Expenses
   * 
   * @returns {Object} NOI calculation
   * @returns {number} returns.effectiveGrossIncome - EGI (income after vacancy)
   * @returns {number} returns.totalExpenses - Total annual operating expenses
   * @returns {number} returns.netOperatingIncome - NOI (annual)
   */
  calculateNOI() {
    const income = this.calculateIncome();
    const expenses = this.calculateOperatingExpenses();
    const netOperatingIncome = income.effectiveGrossIncome - expenses.totalExpenses;
    
    return {
      effectiveGrossIncome: income.effectiveGrossIncome,
      totalExpenses: expenses.totalExpenses,
      netOperatingIncome
    };
  }

  // SECTION 7: Cash Requirements
    /**
   * Calculate total cash requirements
   * 
   * Determines total cash needed including down payment, closing costs,
   * deposits, and any prorations. This is the denominator for Cash-on-Cash ROI.
   * 
   * @returns {Object} Cash requirements
   * @returns {number} returns.deposits - Security deposits or reserves
   * @returns {number} returns.lessProRation - Credits or prorations
   * @returns {number} returns.cashRequiredToClose - Cash needed at closing
   * @returns {number} returns.totalCashRequired - Total cash investment
   */
  calculateCashRequirements() {
    const financing = this.calculateFinancing();
    const { deposits = 0, lessProRation = 0 } = this.inputs;
    const totalCashRequired = financing.cashRequiredToClose + deposits - lessProRation;

    return {
      deposits,
      lessProRation,
      cashRequiredToClose: financing.cashRequiredToClose,
      totalCashRequired
    };
  }

  // SECTION 8: Cashflow Summary Annual
   /**
   * 
   * Computes annual and monthly cash flow by subtracting all expenses and
   * debt service from effective income. Provides per-unit cash flow for
   * multi-family properties.
   * 
   * Formula: Cash Flow = NOI - Annual Debt Service
   * 
   * @returns {Object} Cashflow summary
   * @returns {number} returns.effectiveGrossIncome - Annual EGI
   * @returns {number} returns.operatingExpenses - Annual operating expenses
   * @returns {number} returns.netOperatingIncome - Annual NOI
   * @returns {number} returns.debtServicingCosts - Annual debt service (all loans)
   * @returns {number} returns.annualProfitOrLoss - Annual cash flow
   * @returns {number} returns.totalMonthlyProfitOrLoss - Monthly cash flow
   * @returns {number} returns.cashflowPerUnitPerMonth - Monthly cash flow per unit
   */
  calculateCashflowSummary() {
    const income = this.calculateIncome();
    const expenses = this.calculateOperatingExpenses();
    const noiResult = this.calculateNOI();
    const financing = this.calculateFinancing();
    const propertyInfo = this.getPropertyInfo();

    const annualDebtService = (
      financing.firstMtg.monthlyPayment + 
      financing.secondMtg.monthlyPayment + 
      financing.interestOnly.monthlyPayment +
      financing.otherMonthlyFinancingCosts
    ) * 12;

    const annualProfitOrLoss = noiResult.netOperatingIncome - annualDebtService;
    const totalMonthlyProfitOrLoss = annualProfitOrLoss / 12;
    const cashflowPerUnitPerMonth = propertyInfo.numberOfUnits > 0 
      ? totalMonthlyProfitOrLoss / propertyInfo.numberOfUnits 
      : 0;

    return {
      effectiveGrossIncome: income.effectiveGrossIncome,
      operatingExpenses: expenses.totalExpenses,
      netOperatingIncome: noiResult.netOperatingIncome,
      debtServicingCosts: annualDebtService,
      annualProfitOrLoss,
      totalMonthlyProfitOrLoss,
      cashflowPerUnitPerMonth
    };
  }

  // SECTION 9: Quick Analysis - All Ratios
  /**
   * Calculate quick analysis with all investment ratios
   * 
   * Computes all key investment metrics including Cap Rate, Cash-on-Cash ROI,
   * Debt Coverage Ratio, GRM, Equity ROI, Appreciation ROI, and Total ROI.
   * These metrics are used for investment scoring and comparison.
   * 
   * @returns {Object} Complete investment ratios
   * @returns {number} returns.firstMtgLTV - First mortgage LTV percentage
   * @returns {number} returns.firstMtgLTPP - First mortgage loan-to-purchase-price
   * @returns {number} returns.capRateOnPP - Cap rate based on purchase price
   * @returns {number} returns.capRateOnFMV - Cap rate based on fair market value
   * @returns {number} returns.averageRent - Average rent per unit per month
   * @returns {number} returns.grm - Gross Rent Multiplier (years to payback)
   * @returns {number} returns.dcr - Debt Coverage Ratio
   * @returns {number} returns.cashOnCashROI - Cash-on-Cash return percentage
   * @returns {number} returns.equityROI - Equity buildup return percentage
   * @returns {number} returns.appreciationROI - Appreciation return percentage
   * @returns {number} returns.totalROI - Total return on investment percentage
   * @returns {number} returns.forcedAppROI - Forced appreciation return
   * @returns {number} returns.expenseToIncomeRatio - Expense ratio percentage
   * @returns {number} returns.principalPaidYear1 - Total principal paid in year 1
   * @returns {number} returns.appreciationValue - Dollar appreciation in year 1
   */
  calculateQuickAnalysis() {
    const propertyInfo = this.getPropertyInfo();
    const purchase = this.calculatePurchaseInfo();
    const financing = this.calculateFinancing();
    const income = this.calculateIncome();
    const expenses = this.calculateOperatingExpenses();
    const noiResult = this.calculateNOI();
    const cashflow = this.calculateCashflowSummary();
    const cashReq = this.calculateCashRequirements();

    const firstMtgLTV = propertyInfo.fairMarketValue > 0 
      ? (financing.firstMtg.principalBorrowed / propertyInfo.fairMarketValue) * 100 : 0;
    const firstMtgLTPP = purchase.offerPrice > 0 
      ? (financing.firstMtg.principalBorrowed / purchase.offerPrice) * 100 : 0;
    const secondMtgLTV = propertyInfo.fairMarketValue > 0 
      ? (financing.secondMtg.principal / propertyInfo.fairMarketValue) * 100 : 0;
    const secondMtgLTPP = purchase.offerPrice > 0 
      ? (financing.secondMtg.principal / purchase.offerPrice) * 100 : 0;

    const capRateOnPP = purchase.offerPrice > 0 
      ? (noiResult.netOperatingIncome / purchase.offerPrice) * 100 : 0;
    const capRateOnFMV = propertyInfo.fairMarketValue > 0 
      ? (noiResult.netOperatingIncome / propertyInfo.fairMarketValue) * 100 : 0;

    const averageRent = propertyInfo.numberOfUnits > 0 
      ? income.grossRents / propertyInfo.numberOfUnits / 12 : 0;
    const grm = income.grossRents > 0 
      ? purchase.offerPrice / income.grossRents : 0;
    const dcr = cashflow.debtServicingCosts > 0 
      ? noiResult.netOperatingIncome / cashflow.debtServicingCosts : 0;
    const cashOnCashROI = cashReq.totalCashRequired > 0 
      ? (cashflow.annualProfitOrLoss / cashReq.totalCashRequired) * 100 : 0;

    const firstMtgPrincipalYear1 = calculatePrincipalPaidYear1(
      financing.firstMtg.totalPrincipal,
      financing.firstMtg.monthlyPayment,
      financing.firstMtg.rate
    );
    const secondMtgPrincipalYear1 = financing.secondMtg.principal > 0
      ? calculatePrincipalPaidYear1(
          financing.secondMtg.principal,
          financing.secondMtg.monthlyPayment,
          financing.secondMtg.rate
        ) : 0;
    const totalPrincipalYear1 = firstMtgPrincipalYear1 + secondMtgPrincipalYear1;

    const equityROI = cashReq.totalCashRequired > 0 
      ? (totalPrincipalYear1 / cashReq.totalCashRequired) * 100 : 0;
    const appreciationValue = propertyInfo.fairMarketValue * (propertyInfo.appreciationRate / 100);
    const appreciationROI = cashReq.totalCashRequired > 0 
      ? (appreciationValue / cashReq.totalCashRequired) * 100 : 0;
    const totalROI = cashOnCashROI + equityROI + appreciationROI;
    const forcedAppROI = cashReq.totalCashRequired > 0 
      ? ((propertyInfo.fairMarketValue - purchase.realPurchasePrice) / cashReq.totalCashRequired) * 100 : 0;
    const expenseToIncomeRatio = income.totalIncome > 0 
      ? (expenses.totalExpenses / income.totalIncome) * 100 : 0;

    return {
      firstMtgLTV,
      firstMtgLTPP,
      secondMtgLTV,
      secondMtgLTPP,
      capRateOnPP,
      capRateOnFMV,
      averageRent,
      grm,
      dcr,
      cashOnCashROI,
      equityROI,
      appreciationROI,
      totalROI,
      forcedAppROI,
      expenseToIncomeRatio,
      principalPaidYear1: totalPrincipalYear1,
      appreciationValue
    };
  }
  /**
   * Calculate investment score (0-100)
   * 
   * Assigns a numerical score to the investment based on key metrics:
   * - Cash on Cash ROI (25 points)
   * - Cap Rate (20 points)
   * - Debt Coverage Ratio (20 points)
   * - Monthly Cash Flow (20 points)
   * - Total ROI (15 points)
   * 
   * Score ranges:
   * - 85-100: Excellent (outstanding investment)
   * - 70-84: Good (solid returns expected)
   * - 50-69: Fair (average returns)
   * - 30-49: Risky (below average metrics)
   * - 0-29: Avoid (poor investment, negative cash flow likely)
   * 
   * @returns {Object} Investment score details
   * @returns {number} returns.score - Investment score (0-100)
   * @returns {number} returns.maxScore - Maximum possible score (100)
   * @returns {string} returns.badge - Badge label (excellent/good/fair/risky/avoid)
   * @returns {string} returns.description - Score description
   */
  calculateInvestmentScore() {
    const qa = this.calculateQuickAnalysis();
    const cashflow = this.calculateCashflowSummary();
    
    let score = 0;

    // Cash on Cash ROI (25 points)
    if (qa.cashOnCashROI >= 12) score += 25;
    else if (qa.cashOnCashROI >= 8) score += 20;
    else if (qa.cashOnCashROI >= 5) score += 15;
    else if (qa.cashOnCashROI >= 0) score += 10;
    else if (qa.cashOnCashROI >= -5) score += 5;

    // Cap Rate (20 points)
    if (qa.capRateOnPP >= 10) score += 20;
    else if (qa.capRateOnPP >= 8) score += 17;
    else if (qa.capRateOnPP >= 6) score += 14;
    else if (qa.capRateOnPP >= 5) score += 10;
    else if (qa.capRateOnPP >= 4) score += 7;
    else score += 3;

    // DCR (20 points)
    if (qa.dcr >= 1.5) score += 20;
    else if (qa.dcr >= 1.25) score += 16;
    else if (qa.dcr >= 1.1) score += 12;
    else if (qa.dcr >= 1.0) score += 8;
    else if (qa.dcr >= 0.9) score += 4;

    // Monthly Cash Flow (20 points)
    const monthlyCF = cashflow.totalMonthlyProfitOrLoss;
    if (monthlyCF >= 500) score += 20;
    else if (monthlyCF >= 300) score += 16;
    else if (monthlyCF >= 100) score += 12;
    else if (monthlyCF >= 0) score += 8;
    else if (monthlyCF >= -200) score += 4;

    // Total ROI (15 points)
    if (qa.totalROI >= 20) score += 15;
    else if (qa.totalROI >= 15) score += 12;
    else if (qa.totalROI >= 10) score += 9;
    else if (qa.totalROI >= 5) score += 6;
    else if (qa.totalROI >= 0) score += 3;

    let badge, description;
    if (score >= 85) {
      badge = 'excellent';
      description = 'Outstanding investment - Strong across all metrics';
    } else if (score >= 70) {
      badge = 'good';
      description = 'Good investment - Solid returns expected';
    } else if (score >= 50) {
      badge = 'fair';
      description = 'Fair investment - Average returns';
    } else if (score >= 30) {
      badge = 'risky';
      description = 'Risky investment - Below average metrics';
    } else {
      badge = 'avoid';
      description = 'Poor investment - Negative cash flow likely';
    }

    return { score, maxScore: 100, badge, description };
  }

  /**
   * Get complete investment analysis
   * 
   * Executes all calculation methods and returns a comprehensive analysis
   * object containing property info, purchase details, financing, income,
   * expenses, NOI, cash requirements, cash flow, investment ratios, and
   * investment score.
   * 
   * This is the main method to call for a complete property analysis.
   * 
   * @returns {Object} Complete analysis
   * @returns {Object} returns.propertyInfo - Property information
   * @returns {Object} returns.purchase - Purchase details and RPP
   * @returns {Object} returns.financing - Financing and mortgage details
   * @returns {Object} returns.income - Income breakdown and EGI
   * @returns {Object} returns.expenses - Operating expenses
   * @returns {Object} returns.noi - Net Operating Income
   * @returns {Object} returns.cashRequirements - Cash needed at closing
   * @returns {Object} returns.cashflow - Cash flow summary
   * @returns {Object} returns.quickAnalysis - All investment ratios
   * @returns {Object} returns.investmentScore - Investment score (0-100)
   * 
   * @example
   * const calculator = new BuyRentHoldCalculator(property, inputs);
   * const analysis = calculator.getCompleteAnalysis();
   * 
   * console.log(analysis.quickAnalysis.cashOnCashROI); // 8.5
   * console.log(analysis.cashflow.totalMonthlyProfitOrLoss); // 450
   * console.log(analysis.investmentScore.score); // 75
   */
  getCompleteAnalysis() {
    return {
      propertyInfo: this.getPropertyInfo(),
      purchase: this.calculatePurchaseInfo(),
      financing: this.calculateFinancing(),
      income: this.calculateIncome(),
      expenses: this.calculateOperatingExpenses(),
      noi: this.calculateNOI(),
      cashRequirements: this.calculateCashRequirements(),
      cashflow: this.calculateCashflowSummary(),
      quickAnalysis: this.calculateQuickAnalysis(),
      investmentScore: this.calculateInvestmentScore()
    };
  }
}

// =============================================================================
// QUICK SCORE FOR PROPERTY CARDS (Original)
// =============================================================================

/**
 * Calculate quick investment score for property preview cards
 * 
 * Fast calculation using simplified assumptions for property card hover previews.
 * Uses default financing terms and estimates operating expenses as percentages.
 * Returns a 0-100 score with badge and breakdown of contributing metrics.
 * 
 * This is lighter-weight than the full BuyRentHoldCalculator and suitable
 * for quick comparisons when browsing property listings.
 * 
 * @function
 * @param {number} price - Property list price
 * @param {number} rentEstimate - Estimated monthly rent
 * @param {Object} [propertyData={}] - Optional property data for customization
 * @param {number} [propertyData.downPaymentPercent=20] - Down payment percentage
 * @param {number} [propertyData.interestRate=7.0] - Interest rate percentage
 * @param {number} [propertyData.loanTermYears=30] - Loan term in years
 * @param {number} [propertyData.vacancyRate=5] - Vacancy rate percentage
 * @param {number} [propertyData.managementRate=10] - Management fee percentage
 * @param {number} [propertyData.maintenanceRate=5] - Maintenance percentage
 * @param {Object|null} [scoringConfig=null] - Custom scoring configuration
 * @returns {Object} Quick score result
 * @returns {number} returns.score - Investment score (0-100)
 * @returns {string} returns.badge - Badge (excellent/good/fair/risky/avoid)
 * @returns {string} returns.color - Color code (emerald/green/yellow/orange/red)
 * @returns {string} returns.description - Score description
 * @returns {Object} returns.breakdown - Score breakdown by metric
 * @returns {number} returns.monthlyCashFlow - Monthly cash flow estimate
 * @returns {number} returns.annualCashFlow - Annual cash flow estimate
 * @returns {number} returns.capRate - Cap rate percentage
 * @returns {number} returns.cashOnCashROI - Cash-on-Cash ROI percentage
 * @returns {number} returns.dcr - Debt Coverage Ratio
 * @returns {number} returns.noi - Net Operating Income (annual)
 * @returns {number} returns.totalCashRequired - Total cash needed
 * 
 * @example
 * const score = calculateQuickScore(250000, 2000);
 * console.log(score.score); // 68
 * console.log(score.badge); // "good"
 * console.log(score.monthlyCashFlow); // 324
 */
export function calculateQuickScore(price, rentEstimate, propertyData = {}, scoringConfig = null) {
  if (!price || !rentEstimate) {
    return { 
      score: 0, 
      badge: 'insufficient-data', 
      color: 'gray',
      description: 'Not enough data to calculate score',
      monthlyCashFlow: null, 
      capRate: null,
      cashOnCashROI: null,
      dcr: null,
      breakdown: {}
    };
  }

  // Use passed financing/expense data or defaults
  const downPaymentPercent = propertyData.downPaymentPercent || 20;
  const interestRate = propertyData.interestRate || 7.0;
  const loanTermYears = propertyData.loanTermYears || 30;
  const vacancyRate = propertyData.vacancyRate || 5;
  const managementRate = propertyData.managementRate || 10;
  const maintenanceRate = propertyData.maintenanceRate || 5;

  const downPayment = price * (downPaymentPercent / 100);
  const loanAmount = price - downPayment;
  const monthlyMortgage = calculateMonthlyPayment(loanAmount, interestRate, loanTermYears);
  
  const annualRent = rentEstimate * 12;
  const vacancyLoss = annualRent * (vacancyRate / 100);
  const effectiveIncome = annualRent - vacancyLoss;
  
  const propertyTax = price * 0.012;
  const insurance = price * 0.005;
  const repairs = annualRent * (maintenanceRate / 100);
  const management = annualRent * (managementRate / 100);
  const totalExpenses = propertyTax + insurance + repairs + management;
  
  const noi = effectiveIncome - totalExpenses;
  const annualDebtService = monthlyMortgage * 12;
  const annualCashFlow = noi - annualDebtService;
  const monthlyCashFlow = annualCashFlow / 12;
  
  const capRate = (noi / price) * 100;
  const closingCosts = price * 0.03;
  const totalCashRequired = downPayment + closingCosts;
  const cashOnCashROI = (annualCashFlow / totalCashRequired) * 100;
  const dcr = annualDebtService > 0 ? noi / annualDebtService : 0;
  
  // Calculate score with breakdown
  let score = 0;
  const breakdown = {};
  
  // Cap Rate scoring
  let capRateScore = 0;
  if (capRate >= 10) capRateScore = 100;
  else if (capRate >= 7) capRateScore = 75;
  else if (capRate >= 5) capRateScore = 50;
  else if (capRate >= 3) capRateScore = 25;
  else capRateScore = 10;
  breakdown['Cap Rate'] = { value: capRate, score: capRateScore };
  score += capRateScore * 0.25;
  
  // Cash on Cash scoring
  let cocScore = 0;
  if (cashOnCashROI >= 12) cocScore = 100;
  else if (cashOnCashROI >= 8) cocScore = 75;
  else if (cashOnCashROI >= 5) cocScore = 50;
  else if (cashOnCashROI >= 0) cocScore = 25;
  else cocScore = 10;
  breakdown['CoC ROI'] = { value: cashOnCashROI, score: cocScore };
  score += cocScore * 0.25;
  
  // Cash Flow scoring
  let cfScore = 0;
  if (monthlyCashFlow >= 500) cfScore = 100;
  else if (monthlyCashFlow >= 300) cfScore = 75;
  else if (monthlyCashFlow >= 100) cfScore = 50;
  else if (monthlyCashFlow >= 0) cfScore = 25;
  else cfScore = 10;
  breakdown['Cash Flow'] = { value: monthlyCashFlow, score: cfScore };
  score += cfScore * 0.30;
  
  // DCR scoring
  let dcrScore = 0;
  if (dcr >= 1.5) dcrScore = 100;
  else if (dcr >= 1.25) dcrScore = 75;
  else if (dcr >= 1.1) dcrScore = 50;
  else if (dcr >= 1.0) dcrScore = 25;
  else dcrScore = 10;
  breakdown['DCR'] = { value: dcr, score: dcrScore };
  score += dcrScore * 0.20;
  
  score = Math.round(score);

  let badge, color, description;
  if (score >= 75) {
    badge = 'excellent';
    color = 'emerald';
    description = 'Strong investment with excellent returns';
  } else if (score >= 60) {
    badge = 'good';
    color = 'green';
    description = 'Solid investment opportunity';
  } else if (score >= 45) {
    badge = 'fair';
    color = 'yellow';
    description = 'Average investment, may require negotiation';
  } else if (score >= 30) {
    badge = 'risky';
    color = 'orange';
    description = 'Below average returns, proceed with caution';
  } else {
    badge = 'avoid';
    color = 'red';
    description = 'Poor investment metrics';
  }

  return {
    score,
    badge,
    color,
    description,
    breakdown,
    monthlyCashFlow: Math.round(monthlyCashFlow),
    annualCashFlow: Math.round(annualCashFlow),
    capRate: Math.round(capRate * 100) / 100,
    cashOnCashROI: Math.round(cashOnCashROI * 100) / 100,
    dcr: Math.round(dcr * 100) / 100,
    noi: Math.round(noi),
    totalCashRequired: Math.round(totalCashRequired)
  };
}

// =============================================================================
// ADDITIONAL EXPORTS (for components that need these)
// =============================================================================

/**
 * Alias for BuyRentHoldCalculator
 * @class
 * @deprecated Use BuyRentHoldCalculator instead
 */
export const RentalPropertyCalculator = BuyRentHoldCalculator;

/**
 * Calculate verified investment score
 * 
 * Same as calculateQuickScore but marks the result as verified from RentCast API.
 * This indicates the rent estimate comes from actual market data rather than
 * an internal estimation.
 * 
 * @function
 * @param {number} price - Property list price
 * @param {number} rentEstimate - Verified monthly rent from RentCast API
 * @param {Object} [propertyData={}] - Optional property data
 * @returns {Object} Score result with verified flag and source
 * @returns {boolean} returns.verified - Always true
 * @returns {string} returns.source - Always "RentCast API"
 * 
 * @example
 * const score = calculateVerifiedScore(250000, 2150, propertyData);
 * console.log(score.verified); // true
 * console.log(score.source); // "RentCast API"
 */

// Verified score (same as quick score but marked as verified from API)
export function calculateVerifiedScore(price, rentEstimate, propertyData = {}) {
  const result = calculateQuickScore(price, rentEstimate, propertyData);
  return { ...result, verified: true, source: 'RentCast API' };
}

/**
 * Detect if property is multi-family
 * 
 * Attempts to determine if a property has multiple rental units by checking:
 * 1. RentCast API unit count data
 * 2. User input for number of units
 * 3. Property type keywords (duplex, triplex, fourplex, apartment, multi-family)
 * 4. Defaults to single-family if no indicators found
 * 
 * @function
 * @param {Object} property - Property data object
 * @param {Object} [property.rentCastData] - RentCast API data
 * @param {Object} [property.rentCastData.features] - Property features
 * @param {number} [property.rentCastData.features.unitCount] - Unit count from API
 * @param {string} [property.propertyType] - Property type description
 * @param {string} [property.type] - Alternate property type field
 * @param {number} [property.beds] - Number of bedrooms (used for estimation)
 * @param {Object} inputs - User inputs
 * @param {number} [inputs.numberOfUnits] - User-specified unit count
 * @returns {Object} Multi-family detection result
 * @returns {boolean} returns.isMultiFamily - True if property has multiple units
 * @returns {number} returns.units - Number of units detected
 * @returns {string} returns.source - Detection source (RentCast/Input/Type/Default)
 * 
 * @example
 * const result = detectMultiFamily(property, inputs);
 * if (result.isMultiFamily) {
 *   console.log(`${result.units}-unit property detected via ${result.source}`);
 * }
 */
export function detectMultiFamily(property, inputs) {
  if (property?.rentCastData?.features?.unitCount > 1) {
    return { isMultiFamily: true, units: property.rentCastData.features.unitCount, source: 'RentCast' };
  }
  if (inputs?.numberOfUnits > 1) {
    return { isMultiFamily: true, units: inputs.numberOfUnits, source: 'Input' };
  }
  const type = (property?.propertyType || property?.type || '').toLowerCase();
  if (type.includes('multi') || type.includes('apartment')) {
    return { isMultiFamily: true, units: Math.max(2, Math.floor((property?.beds || 4) / 2)), source: 'Type' };
  }
  if (type.includes('duplex')) return { isMultiFamily: true, units: 2, source: 'Type' };
  if (type.includes('triplex')) return { isMultiFamily: true, units: 3, source: 'Type' };
  if (type.includes('fourplex')) return { isMultiFamily: true, units: 4, source: 'Type' };
  return { isMultiFamily: false, units: 1, source: 'Default' };
}
/**
 * Default scoring configuration
 * 
 * Standard weights and thresholds for investment scoring algorithm.
 * Used when no custom configuration is provided.
 * 
 * @constant {Object}
 * @property {Object} weights - Metric weights (must sum to 100)
 * @property {number} weights.cashOnCash - Cash-on-Cash ROI weight (25 points)
 * @property {number} weights.capRate - Cap Rate weight (20 points)
 * @property {number} weights.dcr - Debt Coverage Ratio weight (20 points)
 * @property {number} weights.monthlyCashflow - Monthly Cash Flow weight (20 points)
 * @property {number} weights.totalROI - Total ROI weight (15 points)
 * @property {Object} thresholds - Performance thresholds for each metric
 */
export const DEFAULT_SCORING_CONFIG = {
  weights: { cashOnCash: 25, capRate: 20, dcr: 20, monthlyCashflow: 20, totalROI: 15 },
  thresholds: {
    cashOnCash: { excellent: 12, good: 8, fair: 5, poor: 0 },
    capRate: { excellent: 10, good: 8, fair: 6, poor: 4 },
    dcr: { excellent: 1.5, good: 1.25, fair: 1.1, poor: 1.0 },
    monthlyCashflow: { excellent: 500, good: 300, fair: 100, poor: 0 },
    totalROI: { excellent: 20, good: 15, fair: 10, poor: 5 }
  }
};

/**
 * Preset scoring configurations for different investor profiles
 * 
 * Three predefined scoring configurations optimized for different
 * investment strategies:
 * 
 * - **Conservative**: Prioritizes safety, higher DCR requirements, demands
 *   strong cash flow cushion
 * - **Moderate**: Balanced approach, standard thresholds for all metrics
 * - **Aggressive**: Growth-focused, accepts lower DCR and negative cash flow
 *   for appreciation potential
 * 
 * @constant {Object}
 * @property {Object} conservative - Conservative investor profile
 * @property {Object} moderate - Moderate/balanced investor profile
 * @property {Object} aggressive - Aggressive/growth investor profile
 * 
 * @example
 * const config = SCORING_PRESETS.conservative;
 * const score = calculateDynamicScore(metrics, config);
 */
export const SCORING_PRESETS = {
  conservative: {
    metrics: {
      capRate: { enabled: true, weight: 30 },
      cashOnCashROI: { enabled: true, weight: 30 },
      monthlyCashFlow: { enabled: true, weight: 25 },
      dcr: { enabled: true, weight: 15 }
    },
    thresholds: {
      capRate: { excellent: 10, good: 8, fair: 6, risky: 4 },
      cashOnCashROI: { excellent: 12, good: 10, fair: 7, risky: 4 },
      monthlyCashFlow: { excellent: 500, good: 350, fair: 200, risky: 50 },
      dcr: { excellent: 1.6, good: 1.4, fair: 1.2, risky: 1.0 }
    }
  },
  moderate: {
    metrics: {
      capRate: { enabled: true, weight: 25 },
      cashOnCashROI: { enabled: true, weight: 25 },
      monthlyCashFlow: { enabled: true, weight: 30 },
      dcr: { enabled: true, weight: 20 }
    },
    thresholds: {
      capRate: { excellent: 10, good: 7, fair: 5, risky: 3 },
      cashOnCashROI: { excellent: 12, good: 8, fair: 5, risky: 2 },
      monthlyCashFlow: { excellent: 500, good: 300, fair: 100, risky: 0 },
      dcr: { excellent: 1.5, good: 1.25, fair: 1.1, risky: 1.0 }
    }
  },
  aggressive: {
    metrics: {
      capRate: { enabled: true, weight: 20 },
      cashOnCashROI: { enabled: true, weight: 20 },
      monthlyCashFlow: { enabled: true, weight: 40 },
      dcr: { enabled: true, weight: 20 }
    },
    thresholds: {
      capRate: { excellent: 8, good: 6, fair: 4, risky: 2 },
      cashOnCashROI: { excellent: 10, good: 6, fair: 3, risky: 0 },
      monthlyCashFlow: { excellent: 400, good: 200, fair: 50, risky: -100 },
      dcr: { excellent: 1.3, good: 1.1, fair: 1.0, risky: 0.9 }
    }
  }
};

/**
 * Estimate monthly rent based on property price
 * 
 * Simple rule-of-thumb estimation when rental data is unavailable.
 * Uses sliding multipliers based on price ranges. Not as accurate as
 * RentCast API data but provides a reasonable fallback estimate.
 * 
 * Price ranges:
 * - Under $150k: 0.9% of price per month
 * - $150k-$300k: 0.8% of price per month
 * - $300k-$500k: 0.7% of price per month
 * - Over $500k: 0.5% of price per month
 * 
 * @function
 * @param {Object} property - Property data
 * @param {number} [property.price] - Property price
 * @param {number} [property.list_price] - Alternate price field
 * @returns {number} Estimated monthly rent (rounded to nearest $50)
 * 
 * @example
 * const rent = estimateRent({ price: 250000 });
 * console.log(rent); // 2000 (rounded)
 */
export function estimateRent(property) {
  const price = property?.price || property?.list_price || 0;
  if (!price) return 0;
  let mult = price &lt; 150000 ? 0.009 : price &lt; 300000 ? 0.008 : price &lt; 500000 ? 0.007 : 0.005;
  return Math.round((price * mult) / 50) * 50;
}

/**
 * Merge scoring configurations
 * 
 * Deep merges base configuration with overrides to create custom scoring config.
 * Useful for allowing users to customize specific thresholds while keeping
 * other settings at defaults.
 * 
 * @function
 * @param {Object} [base={}] - Base configuration object
 * @param {Object} [override={}] - Override configuration object
 * @returns {Object} Merged configuration with weights and thresholds
 * 
 * @example
 * const custom = mergeScoringConfig(
 *   DEFAULT_SCORING_CONFIG,
 *   { thresholds: { cashOnCash: { excellent: 15 } } }
 * );
 */
export function mergeScoringConfig(base = {}, override = {}) {
  return {
    weights: { ...DEFAULT_SCORING_CONFIG.weights, ...base.weights, ...override.weights },
    thresholds: { ...DEFAULT_SCORING_CONFIG.thresholds, ...base.thresholds, ...override.thresholds }
  };
}

/**
 * Calculate dynamic investment score with custom configuration
 * 
 * Scores an investment using provided metrics and custom scoring configuration.
 * Allows for flexible weighting and threshold adjustments based on investor
 * preferences or market conditions.
 * 
 * @function
 * @param {Object} metrics - Investment metrics to score
 * @param {number} metrics.cashOnCashROI - Cash-on-Cash return percentage
 * @param {number} metrics.capRate - Cap rate percentage
 * @param {number} metrics.dcr - Debt coverage ratio
 * @param {number} metrics.monthlyCashflow - Monthly cash flow in dollars
 * @param {number} metrics.totalROI - Total return percentage
 * @param {Object} [config=DEFAULT_SCORING_CONFIG] - Scoring configuration
 * @returns {number} Investment score (0-100)
 * 
 * @example
 * const metrics = {
 *   cashOnCashROI: 9.5,
 *   capRate: 7.2,
 *   dcr: 1.35,
 *   monthlyCashflow: 425,
 *   totalROI: 16.8
 * };
 * const score = calculateDynamicScore(metrics, SCORING_PRESETS.moderate);
 * console.log(score); // 78
 */
export function calculateDynamicScore(metrics, config = DEFAULT_SCORING_CONFIG) {
  let score = 0;
  const { weights, thresholds } = config;
  
  // Cash on Cash
  if (metrics.cashOnCashROI >= thresholds.cashOnCash.excellent) score += weights.cashOnCash;
  else if (metrics.cashOnCashROI >= thresholds.cashOnCash.good) score += weights.cashOnCash * 0.8;
  else if (metrics.cashOnCashROI >= thresholds.cashOnCash.fair) score += weights.cashOnCash * 0.6;
  else score += weights.cashOnCash * 0.3;
  
  // Cap Rate
  if (metrics.capRate >= thresholds.capRate.excellent) score += weights.capRate;
  else if (metrics.capRate >= thresholds.capRate.good) score += weights.capRate * 0.8;
  else if (metrics.capRate >= thresholds.capRate.fair) score += weights.capRate * 0.6;
  else score += weights.capRate * 0.3;
  
  // DCR
  if (metrics.dcr >= thresholds.dcr.excellent) score += weights.dcr;
  else if (metrics.dcr >= thresholds.dcr.good) score += weights.dcr * 0.8;
  else if (metrics.dcr >= thresholds.dcr.fair) score += weights.dcr * 0.6;
  else score += weights.dcr * 0.3;
  
  // Monthly Cashflow
  if (metrics.monthlyCashflow >= thresholds.monthlyCashflow.excellent) score += weights.monthlyCashflow;
  else if (metrics.monthlyCashflow >= thresholds.monthlyCashflow.good) score += weights.monthlyCashflow * 0.8;
  else if (metrics.monthlyCashflow >= thresholds.monthlyCashflow.fair) score += weights.monthlyCashflow * 0.6;
  else score += weights.monthlyCashflow * 0.3;
  
  // Total ROI
  if (metrics.totalROI >= thresholds.totalROI.excellent) score += weights.totalROI;
  else if (metrics.totalROI >= thresholds.totalROI.good) score += weights.totalROI * 0.8;
  else if (metrics.totalROI >= thresholds.totalROI.fair) score += weights.totalROI * 0.6;
  else score += weights.totalROI * 0.3;
  
  return Math.round(score);
}

/**
 * Default values for investment calculations
 * 
 * Standard assumptions used throughout the application when user inputs
 * are not provided. These represent typical market conditions and conservative
 * investing approaches.
 * 
 * @constant {Object}
 * @property {number} ltv - Loan-to-value ratio percentage (80% = 20% down)
 * @property {number} interestRate - Annual mortgage interest rate (7.0%)
 * @property {number} amortization - Loan term in years (30)
 * @property {number} vacancyRate - Expected vacancy percentage (5%)
 * @property {number} managementRate - Property management fee percentage (8%)
 * @property {number} repairsPercent - Repairs as percentage of rent (5%)
 * @property {number} purchaseCostsPercent - Closing costs percentage (3%)
 * @property {number} appreciationRate - Annual appreciation percentage (3%)
 * @property {number} incomeGrowthRate - Annual rent growth percentage (2%)
 * @property {number} expenseGrowthRate - Annual expense inflation percentage (2%)
 * 
 * @example
 * const inputs = {
 *   offerPrice: 250000,
 *   grossRents: 24000,
 *   firstMtgLTV: DEFAULTS.ltv,
 *   firstMtgRate: DEFAULTS.interestRate,
 *   vacancyRate: DEFAULTS.vacancyRate
 * };
 */
export const DEFAULTS = {
  // Financing
  ltv: 80,
  firstMtgLTV: 80,
  interestRate: 7.0,
  firstMtgRate: 7.0,
  amortization: 30,
  firstMtgAmortization: 30,
  downPaymentPercent: 20,
  
  // Closing costs
  purchaseCostsPercent: 3.0,
  closingCostsPercent: 3.0,
  
  // Expenses (as % of rent)
  vacancyRate: 5.0,
  managementRate: 8.0,
  repairsPercent: 5.0,
  maintenanceRate: 5.0,
  capExRate: 5.0,
  
  // Property costs (as % of price)
  propertyTaxRate: 1.2,
  insuranceRate: 0.5,
  
  // Projections
  appreciationRate: 3.0,
  incomeGrowthRate: 2.0,
  expenseGrowthRate: 2.0,
  sellingCosts: 6.0,
  holdingPeriod: 5
};

/**
 * Default module export
 * 
 * Provides all calculator functions and classes in a single object
 * for convenient importing.
 * 
 * @type {Object}
 * @property {class} BuyRentHoldCalculator - Main calculator class
 * @property {class} RentalPropertyCalculator - Alias for BuyRentHoldCalculator
 * @property {Function} calculateQuickScore - Quick scoring function
 * @property {Function} calculateVerifiedScore - Verified scoring function
 * @property {Function} calculateDynamicScore - Dynamic scoring with config
 * @property {Function} detectMultiFamily - Multi-family detection
 * @property {Function} estimateRent - Rent estimation function
 * @property {Function} mergeScoringConfig - Config merging utility
 * @property {Object} DEFAULT_SCORING_CONFIG - Default scoring configuration
 * @property {Object} SCORING_PRESETS - Preset scoring configurations
 * @property {Object} DEFAULTS - Default calculation values
 */
export default { 
  BuyRentHoldCalculator, 
  RentalPropertyCalculator: BuyRentHoldCalculator,
  calculateQuickScore,
  calculateVerifiedScore,
  calculateDynamicScore,
  detectMultiFamily,
  estimateRent,
  mergeScoringConfig,
  DEFAULT_SCORING_CONFIG,
  SCORING_PRESETS,
  DEFAULTS
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-components_analysis_BuyHoldProjections.html">components/analysis/BuyHoldProjections</a></li><li><a href="module-components_analysis_PurchaseWorksheet.html">components/analysis/PurchaseWorksheet</a></li><li><a href="module-components_features_ExpandedPropertyView.html">components/features/ExpandedPropertyView</a></li><li><a href="module-components_features_PropertiesGrid.html">components/features/PropertiesGrid</a></li><li><a href="module-components_features_PropertyCard.html">components/features/PropertyCard</a></li><li><a href="module-components_features_PropertyMap.html">components/features/PropertyMap</a></li><li><a href="module-config_firebase.html">config/firebase</a></li><li><a href="module-contexts_AuthContext.html">contexts/AuthContext</a></li><li><a href="module-hooks_useSavedProperties.html">hooks/useSavedProperties</a></li><li><a href="module-pages_Properties.html">pages/Properties</a></li><li><a href="module-pages_PropertyAnalysisPage.html">pages/PropertyAnalysisPage</a></li><li><a href="module-services_database.html">services/database</a></li><li><a href="module-services_realtyAPI.html">services/realtyAPI</a></li><li><a href="module-services_rentCastApi.html">services/rentCastApi</a></li></ul><h3>Classes</h3><ul><li><a href="BuyRentHoldCalculator.html">BuyRentHoldCalculator</a></li><li><a href="RentalPropertyCalculator.html">RentalPropertyCalculator</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CurrencyInput">CurrencyInput</a></li><li><a href="global.html#DEFAULTS">DEFAULTS</a></li><li><a href="global.html#DEFAULT_SCORING_CONFIG">DEFAULT_SCORING_CONFIG</a></li><li><a href="global.html#Dashboard">Dashboard</a></li><li><a href="global.html#InlineInput">InlineInput</a></li><li><a href="global.html#NumberInput">NumberInput</a></li><li><a href="global.html#PercentInput">PercentInput</a></li><li><a href="global.html#Profile">Profile</a></li><li><a href="global.html#SCORING_PRESETS">SCORING_PRESETS</a></li><li><a href="global.html#applyScoringPreset">applyScoringPreset</a></li><li><a href="global.html#calculateDistance">calculateDistance</a></li><li><a href="global.html#calculateDynamicScore">calculateDynamicScore</a></li><li><a href="global.html#calculateInvestmentScore">calculateInvestmentScore</a></li><li><a href="global.html#calculateMonthlyPayment">calculateMonthlyPayment</a></li><li><a href="global.html#calculatePolygonArea">calculatePolygonArea</a></li><li><a href="global.html#calculatePrincipalPaidYear1">calculatePrincipalPaidYear1</a></li><li><a href="global.html#calculateProfileScore">calculateProfileScore</a></li><li><a href="global.html#calculateQuickScore">calculateQuickScore</a></li><li><a href="global.html#calculateVerifiedScore">calculateVerifiedScore</a></li><li><a href="global.html#clearCache">clearCache</a></li><li><a href="global.html#detectMultiFamily">detectMultiFamily</a></li><li><a href="global.html#detectMultiFamilyFromType">detectMultiFamilyFromType</a></li><li><a href="global.html#estimateRent">estimateRent</a></li><li><a href="global.html#estimateUnitsFromProperty">estimateUnitsFromProperty</a></li><li><a href="global.html#filterPropertiesInBoundary">filterPropertiesInBoundary</a></li><li><a href="global.html#formatArea">formatArea</a></li><li><a href="global.html#formatDistance">formatDistance</a></li><li><a href="global.html#getAvailableMetrics">getAvailableMetrics</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getExpenseDefaults">getExpenseDefaults</a></li><li><a href="global.html#getFinancingDefaults">getFinancingDefaults</a></li><li><a href="global.html#getInvestmentTargets">getInvestmentTargets</a></li><li><a href="global.html#getInvestmentThresholds">getInvestmentThresholds</a></li><li><a href="global.html#getInvestorProfile">getInvestorProfile</a></li><li><a href="global.html#getPolygonCenter">getPolygonCenter</a></li><li><a href="global.html#getPreferredLocation">getPreferredLocation</a></li><li><a href="global.html#getPropertiesCountInBoundary">getPropertiesCountInBoundary</a></li><li><a href="global.html#getPropertyCoordinates">getPropertyCoordinates</a></li><li><a href="global.html#getPropertyDataOnHover">getPropertyDataOnHover</a></li><li><a href="global.html#getPropertyDetails">getPropertyDetails</a></li><li><a href="global.html#getRentEstimate">getRentEstimate</a></li><li><a href="global.html#getScoringPresets">getScoringPresets</a></li><li><a href="global.html#getScoringWeights">getScoringWeights</a></li><li><a href="global.html#hasPreferredLocation">hasPreferredLocation</a></li><li><a href="global.html#isPointInCircle">isPointInCircle</a></li><li><a href="global.html#isPointInPolygon">isPointInPolygon</a></li><li><a href="global.html#mapPropertyType">mapPropertyType</a></li><li><a href="global.html#meetsInvestmentCriteria">meetsInvestmentCriteria</a></li><li><a href="global.html#mergeScoringConfig">mergeScoringConfig</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#saveInvestorProfile">saveInvestorProfile</a></li><li><a href="global.html#toRad">toRad</a></li><li><a href="global.html#validateProfile">validateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Dec 22 2025 22:17:13 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
